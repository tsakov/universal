var fluid = require("universal");
var gpii = fluid.registerNamespace("gpii");
var pcp = fluid.registerNamespace("gpii.pcp");

var fs = require("fs");
var jsdom = require("jsdom");

//pcp.genericTemplatesDirectory = "";

pcp.removeSpaces = function (str) {
    return str.split(" ").join("");
};

pcp.generatePreferenceHtml = function (preference) {
    // choose a generic template based on preference.valueSpace
    var genericTemplatePath = "./content/deps/genericControls/html/genericDropdown.html";
    var htmlSource = fs.readFileSync(genericTemplatePath, "utf8");

    jsdom.env({
        html: htmlSource,
        scripts: ["http://code.jquery.com/jquery.js"],
        done: function (errors, domWindow) {
            var $ = domWindow.$;
            var genericClass = "flc-uiOptions-genericDropdown"; // THIS DEPENDS ON PREFERENCE.VALUESPACE
            var newClass = "pcp-" + pcp.removeSpaces(preference.preferenceName);

            for (suffix in { "": null, "Label": null, "Description": null }) {
                $("." + genericClass + suffix).removeClass(genericClass + suffix)
                                              .addClass(newClass + suffix);
            }

            var output = $("body").html();
            var outputPath = "content/temp/" + pcp.removeSpaces(preference.preferenceName) + ".html";
            fs.writeFileSync(outputPath, output);
        }
    });
};

pcp.generateOnloadJavaScript = function (displayedPreferences) {
    var indexTemplateSource = fs.readFileSync("./content/deps/pcp_templates/index.html", "utf8");

    jsdom.env({
        html: indexTemplateSource,
        scripts: ["http://code.jquery.com/jquery.js"],
        done: function (errors, domWindow) {
            var $ = domWindow.$;

            $("body").attr("onload", "uiOptionsInit(" + JSON.stringify(displayedPreferences) + ")");

            var output = $("html").html();
            fs.writeFileSync("content/index.html", output);
        }
    });
};

pcp.generateMainDialog = function (displayedPreferences) {
    var mainDialogTemplateSource = fs.readFileSync("./content/deps/pcp_templates/pcpMainDialog.html", "utf8");

    jsdom.env({
        html: mainDialogTemplateSource,
        scripts: ["http://code.jquery.com/jquery.js"],
        done: function (errors, domWindow) {
            var $ = domWindow.$;

            for (var i = 0; i < displayedPreferences.length; ++i) {
                var prefClass = "pcp-" + pcp.removeSpaces(displayedPreferences[i].preferenceName);
                var div = "<div class=\"" + prefClass + " fl-uiOptions-layout fl-col-flex\"> </div>"
                $(".fl-uiOptions-category").append(div);
            }

            var output = $("body").html();
            fs.writeFileSync("content/temp/pcpMainDialog.html", output);
        }
    });
};

pcp.generateIndex = function (displayedPreferences) {
    // foreach pref in displayedPreferences generate an html template
    // and a script for the index.html
    for (var i = 0; i < displayedPreferences.length; ++i) {
        pcp.generatePreferenceHtml(displayedPreferences[i]);
    }

    pcp.generateMainDialog(displayedPreferences);
    pcp.generateOnloadJavaScript(displayedPreferences);
};