var fluid = fluid || {};

(function ($, fluid) {
    
    // registering this typetag allows the framework to know we're in a particular environment
    fluid.staticEnvironment.gpiiPcp = fluid.typeTag("gpii.pcp");

    fluid.defaults("gpii.pcp.store", {
        // "fluid.uiOptions.store" is the base grade for any settings store
        gradeNames: ["fluid.uiOptions.store", "autoInit"],
        invokers: {
            fetch: {
                funcName: "gpii.pcp.store.fetch",
                args: ["{store}.options.userToken", "{store}.options.defaultSiteSettings"]
            },
            save: {
                funcName: "gpii.pcp.store.save",
                args: ["{arguments}.0", "{store}.options.userToken", "{store}.options.dictionary"]
            }
        },

        // your Store can define whatever options you need
        userToken: "testToken",
        dictionary: {   // A simple map between uiOptions and GPII settings names
            /*textSize: "http://registry.gpii.org/common/fontSize",
            theme:    "http://registry.gpii.org/common/foregroundColor",*/

            onScreenKeyboardShow:     "http://registry.gpii.org/common/onScreenKeyboardShow",
            onScreenKeyboardLocation: "http://registry.gpii.org/common/onScreenKeyboardLocation",

            audioFeedbackPlay:   "http://registry.gpii.org/common/audioFeedbackPlay",
            audioFeedbackVolume: "http://registry.gpii.org/common/audioFeedbackVolume",

            sampleCheckbox:     "http://registry.gpii.org/common/sampleCheckbox",
            sampleDropdown:     "http://registry.gpii.org/common/sampleDropdown",
            sampleRadioButtons: "http://registry.gpii.org/common/sampleRadioButtons",
            sampleSlider:       "http://registry.gpii.org/common/sampleSlider"
        }
    });

    // your fetch and save can be written however you need
    gpii.pcp.store.fetch = function (userToken, defaultSettings) {
        var savedSettings;
        
        // do an $.ajax(get...) to retrieve the saved settings from the server
        
        // if there are no saved settings, just return the defaults
        return savedSettings || defaultSettings;
    };

    gpii.pcp.store.save = function (settings, userToken, dict) {
        var gpiiSettings = {};

        fluid.each(settings, function(value, key){
            if(dict[key]) {
                gpiiSettings[dict[key]] = value;
            }
        });

        $.ajax({
            type: "POST",
            url: "/pcp/update",
            
            // sending settings instead of gpiiSettings for testing purposes
            data: settings// gpiiSettings
        });
    };

    // This demands block says:
    // "When 'gpii.pcp' is in the environment, use 'gpii.pcp.store' instead of the default."
    fluid.demands("fluid.uiOptions.store", ["fluid.uiEnhancer", "gpii.pcp"], {
        funcName: "gpii.pcp.store"
    });


})(jQuery, fluid);