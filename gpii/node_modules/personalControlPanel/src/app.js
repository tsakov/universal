var appjs = require("appjs");
var fluid = require("universal");

var gpii = fluid.registerNamespace("gpii");
var pcp = fluid.registerNamespace("gpii.pcp");
fluid.require("./content/deps/genericUtilities.js", require);

appjs.serveFilesFrom(__dirname + "/content");

var token = process.argv[2] || "John_Doe";
var displayedPreferences = process.argv[3] ? JSON.parse(process.argv[3]) :
                                             [ { id: "registry*gpii*org/common/fontSize",
                                                 preferenceName: "Font Size",
                                                 preferenceDescription: "Make letters bigger or smaller.",
                                                 valueSpace: "boolean",
                                                 value: false },

                                               { id: "registry*gpii*org/common/something",
                                                 preferenceName: "Something",
                                                 preferenceDescription: "It's something...",
                                                 valueSpace: "boolean",
                                                 value: true },

                                               { id: "registry*gpii*org/common/somethingElse",
                                                 preferenceName: "Something Else",
                                                 preferenceDescription: "It's still something...",
                                                 valueSpace: "boolean",
                                                 value: false },

                                               { id: "registry*gpii*org/common/somethingSomething",
                                                 preferenceName: "Something Something",
                                                 preferenceDescription: "Something, something, something, Dark Side",
                                                 valueSpace: "boolean",
                                                 value: true } ];

displayedPreferences = [ { id: "registry*gpii*org/common/something",
                           preferenceName: "Something",
                           preferenceDescription: "It's something...",
                           valueSpace: ["one", "two", "three"],
                           value: "four" },

                         { id: "registry*gpii*org/common/somethingSomething",
                           preferenceName: "Something Something",
                           preferenceDescription: "Something, something, something, Dark Side",
                           valueSpace: ["boolean", "string" , "number"],
                           value: "string" } ]
// generate index.html and required html templates
pcp.generateIndex(displayedPreferences);


// some delay to write the html files on the disk
// will be replaced by fluid events
setTimeout(function () {
    // create a window
    var window = appjs.createWindow({
        width: 0,
        height: 0,
        alpha: true,
        showChrome: true,
        autoResize: true
    });


    appjs.router.post("/pcp/update", function(request, response, next){
        //redirect the http request to the gpii local server (localhost:8081)

        console.log(require("querystring").parse(request.post))

        response.send(204);
    });

    // prepare the window when first created
    window.on("create", function(){
        // window.frame controls the desktop window
        window.frame.show().center();
        //window.frame.openDevTools();
    });

    // the window is ready when the DOM is loaded
    window.on("ready", function(){
        // directly interact with the DOM

        console.log(token);
        console.log(displayedPreferences);
        console.log(__dirname)

        window.process = process;
        window.module = module;

        window.addEventListener('keydown', function(e){
            if (e.keyIdentifier === 'F12') {
                window.frame.openDevTools();
            }
        });
    });

    // cleanup code when window is closed
    window.on("close", function(){
        console.log("Window Closed");
        // empty "./content/temp"
    });
}, 3000);