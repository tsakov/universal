(function () {

    "use strict";

    var fluid = require("infusion");
    var gpii = fluid.registerNamespace("gpii");
    var spawn = require("child_process").spawn;

    fluid.require("gpiiFramework", require);
    fluid.require("./pcpUpdate.js", require);

    fluid.defaults("gpii.personalControlPanel", {
        gradeNames: ["gpii.app", "autoInit"],
        preInitFunction: "gpii.personalControlPanel.preInit",
        handlers: {
            pcpUpdate: {
                route: "/pcp/update",
                type: "post"
            }
        }
    });

    gpii.personalControlPanel.preInit = function (that) {
        // TODO: Support multiple sessions like LifeCycleManager

        that.start = function () {
            that.options.pcpInstance = spawn("node", ["--harmony", __dirname + "/app.js", __dirname, that.userToken]);
        };

        that.stop = function () {
            that.options.pcpInstance.kill();
        };
    };

})();
