(function () {

    "use strict";

    var fluid = require("infusion");
    var gpii = fluid.registerNamespace("gpii");
    var spawn = require("child_process").spawn;
    var fs = require("fs");
    var jsdom = require("jsdom");

    fluid.require("gpiiFramework", require);
    fluid.require("./pcpUpdate.js", require);

    fluid.defaults("gpii.personalControlPanel", {
        gradeNames: ["gpii.app", "autoInit"],
        preInitFunction: "gpii.personalControlPanel.preInit",
        components: {
            initializer: {
                type: "gpii.personalControlPanel.initializer"
            }
        },
        handlers: {
            pcpUpdate: {
                route: "/pcp/update",
                type: "post"
            }
        }
    });

    fluid.defaults("gpii.personalControlPanel.initializer", {
        gradeNames: ["fluid.eventedComponent", "autoInit"],
        preInitFunction: "gpii.personalControlPanel.initializer.preInit",
        defaultSetup: [ { id: "http://registry.gpii.org/common/fontSize",
                          preferenceName: "Font Size",
                          preferenceDescription: "Make letters bigger or smaller.",
                          valueSpace: {start: 8, end: 24, step: 1},
                          value: 12 },

                        { id: "http://registry.gpii.org/common/foregroundColor",
                          preferenceName: "Foreground Color",
                          preferenceDescription: "Change the color of letters.",
                          valueSpace: ["Black", "White", "Green", "Blue", "Yellow"],
                          value: "Black" },

                        { id: "http://registry.gpii.org/common/highContrast",
                          preferenceName: "High Contrast",
                          preferenceDescription: "",
                          valueSpace: "boolean",
                          value: false } ],
        events: {
            onMainDialog: null,
            onIndex: null,
            onReadyToLaunch: {
                events: {
                   onMainDialog: "onMainDialog",
                   onIndex: "onIndex"
                },
                args: ["{gpii.personalControlPanel}"]
            }
        },
        listeners: {
            "onReadyToLaunch": "gpii.personalControlPanel.launch"
        }
    });

    gpii.personalControlPanel.preInit = function (that) {
        // TODO: Support multiple sessions like LifeCycleManager

        that.start = function () {
            that.initializer.init();
        };

        that.stop = function () {
            that.options.pcpInstance.kill();

            var prefix = __dirname;
            fs.unlink(prefix + "/content/temp/pcpMainDialog.html");
            fs.unlink(prefix + "/content/index.html");
        };
    };

    gpii.personalControlPanel.initializer.preInit = function (that) {
        that.removeSpaces = function (str) {
            return str.replace(/ /g, "");
        };

        var prefix = __dirname;

        that.generateMainDialog = function (displayedPreferences) {
            var mainDialogTemplateSource = fs.readFileSync(prefix + "/content/deps/pcp_templates/pcpMainDialog.html", "utf8");

            jsdom.env({
                html: mainDialogTemplateSource,
                scripts: ["http://code.jquery.com/jquery.js"],
                done: function (errors, window) {
                    var $ = window.$;

                    for (var i = 0; i < displayedPreferences.length; ++i) {
                        var prefClass = "pcp-" + that.removeSpaces(displayedPreferences[i].preferenceName);
                        var div = "<div class=\"" + prefClass + " fl-uiOptions-layout fl-col-flex\"> </div>"
                        $(".fl-uiOptions-category").append(div);
                    }

                    var output = $("body").html();
                    fs.writeFile(prefix + "/content/temp/pcpMainDialog.html", output, function (err) {
                        if(err || !fs.existsSync(prefix + "/content/temp/pcpMainDialog.html")) {
                            fluid.fail("Could not load the main dialog");
                        } else {
                            that.events.onMainDialog.fire();
                        }
                    });
                }
            });
        };

        that.generateIndex = function (displayedPreferences) {
            var indexTemplateSource = fs.readFileSync(prefix + "/content/deps/pcp_templates/index.html", "utf8");

            jsdom.env({
                html: indexTemplateSource,
                scripts: ["http://code.jquery.com/jquery.js"],
                done: function (errors, window) {
                    var $ = window.$;

                    $("body").attr("onload", "uiOptionsInit(" + JSON.stringify(displayedPreferences) + ")");
                    $(".jsdom").remove();

                    var output = $("html").html();
                    fs.writeFile(prefix + "/content/index.html", output, function (err) {
                        if(err || !fs.existsSync(prefix + "/content/index.html")) {
                            fluid.fail("Could not load the index");
                        } else {
                            that.events.onIndex.fire();
                        }
                    });
                }
            });
        };

        that.init = function (displayedPreferences) {
            displayedPreferences = displayedPreferences || that.options.defaultSetup;

            that.generateMainDialog(displayedPreferences);
            that.generateIndex(displayedPreferences);
        };
    };

    gpii.personalControlPanel.launch = function (personalControlPanel) {
        personalControlPanel.options.pcpInstance = spawn("node", ["--harmony", __dirname + "/app.js", personalControlPanel.userToken]);
    };

})();
